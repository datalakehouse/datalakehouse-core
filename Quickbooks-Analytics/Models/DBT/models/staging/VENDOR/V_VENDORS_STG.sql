{{ config (
  materialized= 'view',
  schema= 'QUICKBOOKS',
  tags= ["staging","daily"]
)
}}

WITH source AS (
  SELECT 
  * 
  FROM  	
    {{source('DEMO_QUICKBOOKS','VENDOR')}}
),
source_term AS (
  SELECT 
  * 
  FROM  	
    {{ref('W_TERM_D')}}
),
rename AS 
(   
SELECT 
    --MD5
    MD5( TRIM(COALESCE(A.ID,'00000000000000000000000000000000')) ) AS K_VENDOR_DLHK
    ,B.K_TERM_DLHK
    --BUSINESS KEYS
    ,A.ID AS K_VENDOR_BK
    ,A.CURRENCY_ID AS K_CURRENCY_BK
    ,A.BILLING_ADDRESS_ID AS K_BILLING_ADDRESS_BK
    ,B.K_TERM_BK
     --ATTRIBUTES    
    --ATTRIBUTES
    ,{{full_name('GIVEN_NAME','MIDDLE_NAME', 'FAMILY_NAME')}} AS A_FULL_NAME
    ,A.GIVEN_NAME AS A_GIVEN_NAME
    ,A.MIDDLE_NAME AS A_MIDDLE_NAME
    ,A.FAMILY_NAME AS A_FAMILY_NAME
    ,A.DISPLAY_NAME AS A_DISPLAY_NAME
    ,A.TAX_IDENTIFIER AS A_TAX_IDENTIFIER
    ,A.COMPANY_NAME AS A_COMPANY_NAME
    ,A.SUFFIX AS A_SUFFIX
    ,A.TITLE AS A_TITLE    
    ,A.PRINT_ON_CHECK_NAME AS A_PRINT_ON_CHECK_NAME
    ,A.EMAIL AS A_EMAIL
    ,A.WEB_URL AS A_WEB_URL    
    ,A.ALTERNATE_PHONE AS A_ALTERNATE_PHONE_NUMBER    
    ,A.PRIMARY_PHONE AS A_PRIMARY_PHONE
    ,A.MOBILE_PHONE AS A_MOBILE_NUMBER
    ,A.FAX_NUMBER AS A_FAX_NUMBER
    ,A.ACCOUNT_NUMBER AS A_ACCOUND_NUMBER
    ,A.SYNC_TOKEN AS A_SYNC_TOKEN
    ,A.OTHER_CONTACTS AS A_OTHER_CONTACTS
    ,B.A_NAME AS A_TERM_NAME
    ,B.A_TYPE AS A_TERM_TYPE
    ,B.A_DUE_DAYS AS A_TERM_DUE_DAYS
    --BOOLEAN
    ,A.VENDOR_1099:BOOLEAN AS B_VENDOR_1099
    ,A.ACTIVE:BOOLEAN AS B_ACTIVE
    --TIMESTAMP
    ,A.CREATED_AT AS A_CREATED_AT_DTS
    ,A.UPDATED_AT AS A_UPDATED_AT_DTS    
    --METRICS    
    ,A.BALANCE::decimal(15,2) AS M_BALANCE    
    --METADATA
    ,CURRENT_TIMESTAMP as MD_LOAD_DTS
    ,'{{invocation_id}}' AS MD_INTGR_ID
  FROM
    source  A
    LEFT JOIN source_term B on B.K_TERM_BK = A.TERM_ID
)


SELECT * FROM rename