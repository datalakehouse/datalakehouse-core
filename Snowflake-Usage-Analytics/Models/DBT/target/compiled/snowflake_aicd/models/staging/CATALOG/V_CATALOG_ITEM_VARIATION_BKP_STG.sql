
 

WITH source AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DEMO_SQUARE_ALT13."CATALOG_ITEM"
),
source_variation AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DEMO_SQUARE_ALT13."CATALOG_ITEM_VARIATION"
),
source_category AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DBT_SQUARE.V_CATALOG_CATEGORY_STG
),
source_order_line_item AS (
SELECT DISTINCT K_POS_ORDER_DLHK,K_POS_CATALOG_OBJECT_DLHK,K_POS_CATALOG_OBJECT_BK, K_POS_ORDER_LINE_BK,A_POS_ORDER_LINE_VARIATION_NAME,A_POS_ORDER_LINE_NAME  FROM  DEVELOPER_SANDBOX.DBT_SQUARE.V_ORDER_LINE_ITEM_STG
),
source_order AS (
SELECT DISTINCT K_POS_ORDER_DLHK,K_POS_LOCATION_BK  FROM  DEVELOPER_SANDBOX.DBT_SQUARE.V_ORDER_HEADER_STG
),
rename as (


SELECT DISTINCT
       --MD5 KEYS        
        OLI.K_POS_CATALOG_OBJECT_DLHK AS K_POS_CATALOG_OBJECT_VARIATION_DLHK    
            
        ,MD5( COALESCE(S.ID,'00000000000000000000000000000000')) AS K_POS_CATALOG_OBJECT_DLHK      
        --BUSINESS KEYS
        ,OLI.K_POS_CATALOG_OBJECT_BK AS K_POS_CATALOG_OBJECT_VARIATION_BK   
        ,COALESCE(O.K_POS_LOCATION_BK,'N/A') AS K_POS_LOCATION_BK
        ,S.ID AS K_POS_CATALOG_OBJECT_BK
        --DESCRIPTION
        ,COALESCE(S.NAME, OLI.A_POS_ORDER_LINE_NAME) AS A_POS_PRODUCT_NAME
        ,COALESCE(OLI.A_POS_ORDER_LINE_VARIATION_NAME, 'N/A') AS A_POS_PRODUCT_SUB_NAME
        ,COALESCE(CAT.A_POS_PRODUCT_CATEGORY, 'No Category') AS A_POS_CATEGORY_NAME
        , 'ORDER LINE ITEM VARIATION' AS A_POS_USAGE
        ,S.DESCRIPTION AS A_POS_PRODUCT_DESCRIPTION
        ,S.ABBREVIATION AS A_POS_PRODUCT_ABBREVIATION
        ,S.PRODUCT_TYPE AS A_POS_PRODUCT_TYPE
        ,V.NAME AS A_POS_PRODUCT_VARIATION_NAME
        ,V.SKU AS A_POS_PRODUCT_SKU
        ,V.UPC AS A_POS_PRODUCT_UPC
        ,V.ORDINAL AS A_POS_ORDINAL_VARIATION 
        ,V.PRICING_TYPE AS A_POS_VARIATION_PRICING_TYPE
        ,V.PRICE_MONEY_CURRENCY AS A_POS_VARIATION_PRICE_MONEY_CURRENCY
        --METRIC
        ,V.PRICE_MONEY_AMOUNT AS M_POS_PRICE_MONEY_AMOUNT
        --metadata (MD)
        , CURRENT_TIMESTAMP AS MD_LOAD_DTS        
        , '58da106b-8574-48e3-a968-ba4a8e9431e6' AS MD_INTGR_ID
FROM
    source_order_line_item OLI
    LEFT JOIN source_order O ON O.K_POS_ORDER_DLHK = OLI.K_POS_ORDER_DLHK
    LEFT JOIN source_variation AS V ON V.ID = OLI.K_POS_CATALOG_OBJECT_BK
    LEFT JOIN source AS S ON S.ID = V.ITEM_ID
    LEFT JOIN source_category AS CAT ON CAT.K_POS_CATALOG_CATEGORY_BK = S.CATEGORY_ID
--GROUP BY 
--1,2,3,6,7,8,9,10,11,12,13,14,15,16,17,18,19
)

SELECT * FROM rename