
 

WITH product AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DBT_SHOPIFY.V_PRODUCT_STG
),
product_variant AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DBT_SHOPIFY.V_PRODUCT_VARIANT_STG
),

rename as (


SELECT
    MD5(CONCAT(P.K_PRODUCT_BK,'-',COALESCE(V.K_PRODUCT_VARIANT_BK,'0000000000'))) AS K_PRODUCT_VARIATION_DLHK
    ,P.K_PRODUCT_DLHK
    ,V.K_PRODUCT_VARIANT_DLHK AS K_PRODUCT_VARIANT_DLHK
    ,V.K_PRODUCT_VARIANT_BK AS K_PRODUCT_VARIANT_BK
    ,P.K_PRODUCT_BK AS K_PRODUCT_BK
    ,V.K_INVENTORY_ITEM_BK AS K_VARIANT_INVENTORY_ITEM_BK
    ,V.K_IMAGE_BK AS K_VARIANT_IMAGE_BK
    --ATTRIBUTES
    ,P.A_TITLE
    ,P.A_HANDLE
    ,P.A_PRODUCT_TYPE
    ,P.A_VENDOR
    ,P.A_CREATED_AT_DTS
    ,P.A_UPDATED_AT_DTS
    ,P.A_PUBLISHED_AT_DTS
    ,P.A_PUBLISHED_SCOPE
    ,P.A_STATUS
    ,P.A_TEMPLATE_SUFFIX       
    ,V.A_TITLE AS A_VARIANT_TITLE
    ,V.A_SKU AS A_VARIANT_SKU
    ,V.A_FULFILLMENT_SERVICE AS A_VARIANT_FULFILLMENT_SERVICE
    ,V.A_INVENTORY_MANAGEMENT AS A_VARIANT_INVENTORY_MANAGEMENT
    ,V.A_BARCODE AS A_VARIANT_BARCODE
    ,V.A_INVENTORY_POLICY AS A_VARIANT_INVENTORY_POLICY
    ,V.A_GRAMS AS A_VARIANT_GRAMS
    ,V.A_WEIGHT_UNIT AS A_VARIANT_WEIGHT_UNIT
    ,V.A_OPTION_1 AS A_VARIANT_OPTION_1
    ,V.A_OPTION_2 AS A_VARIANT_OPTION_2
    ,V.A_OPTION_3 AS A_VARIANT_OPTION_3
    ,V.A_TAX_CODE AS A_VARIANT_TAX_CODE
    ,V.A_PRESENTMENT_PRICES AS A_VARIANT_PRESENTMENT_PRICES
    ,V.A_CREATED_AT_DTS AS A_VARIANT_CREATED_AT_DTS
    ,V.A_UPDATED_AT_DTS AS A_VARIANT_UPDATED_AT_DTS
    --BOOLEAN
    ,V.B_REQUIRES_SHIPPING AS B_VARIANT_REQUIRES_SHIPPING
    ,V.B_TAXABLE AS B_VARIANT_TAXABLE
    --METRICS
    ,V.M_PRICE AS M_VARIANT_PRICE
    ,V.M_POSITION AS M_VARIANT_POSITION
    ,V.M_COMPARE_AT_PRICE AS M_VARIANT_COMPARE_AT_PRICE
    ,V.M_INVENTORY_QUANTITY AS M_VARIANT_INVENTORY_QUANTITY
    ,V.M_INVENTORY_QUANTITY_ADJUSTMENT AS M_VARIANT_INVENTORY_QUANTITY_ADJUSTMENT
    ,V.M_WEIGHT AS M_VARIANT_WEIGHT
    --metadata (MD)
    ,P.MD_IS_DELETED AS MD_IS_DELETED_PRODUCT
    ,V.MD_IS_DELETED AS MD_IS_DELETED_VARIANT
    , CURRENT_TIMESTAMP AS MD_ELT_UPDATED_DTS        
    , 'cc5603df-43e1-42fa-bf2e-6c12e9f40242' AS MD_INTGR_ID
FROM
    product P
    LEFT JOIN product_variant V ON V.K_PRODUCT_BK = P.K_PRODUCT_BK
)

SELECT * FROM rename