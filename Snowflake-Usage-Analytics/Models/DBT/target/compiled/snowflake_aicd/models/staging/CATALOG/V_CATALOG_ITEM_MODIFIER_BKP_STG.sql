

--set source_relation on table to see if that exists on source


WITH 
source_order_line_item_modifier AS (
SELECT DISTINCT  A_POS_ORDER_LINE_MODIFIER_NAME,K_POS_CATALOG_OBJECT_DLHK,K_POS_ORDER_LINE_ITEM_BK,K_POS_CATALOG_OBJECT_BK,K_POS_ORDER_BK FROM  DEVELOPER_SANDBOX.DBT_SQUARE.V_ORDER_LINE_ITEM_MODIFIER_STG
),

--checking if catalog_modifier exists on source. if not, set an empty table with columns required on join and select statement


source_catalog_modifier AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DEMO_SQUARE_ALT13."CATALOG_MODIFIER"
),



source_order_line_item AS (
SELECT DISTINCT K_POS_ORDER_DLHK,K_POS_CATALOG_OBJECT_DLHK,K_POS_CATALOG_OBJECT_BK, K_POS_ORDER_LINE_BK,A_POS_ORDER_LINE_NAME,A_POS_ORDER_LINE_VARIATION_NAME,K_POS_ORDER_BK FROM  DEVELOPER_SANDBOX.DBT_SQUARE.V_ORDER_LINE_ITEM_STG
),
source_catalog_item AS (
SELECT DISTINCT K_POS_CATALOG_OBJECT_BK, K_POS_CATALOG_OBJECT_DLHK,K_POS_CATALOG_OBJECT_VARIATION_DLHK,K_POS_CATALOG_OBJECT_VARIATION_BK,A_POS_CATEGORY_NAME,A_POS_PRODUCT_NAME FROM  DEVELOPER_SANDBOX.DBT_SQUARE.V_CATALOG_ITEM_VARIATION_STG
),
source_category AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DBT_SQUARE.V_CATALOG_CATEGORY_STG
),
source_order AS (
SELECT DISTINCT K_POS_ORDER_DLHK,K_POS_LOCATION_BK  FROM  DEVELOPER_SANDBOX.DBT_SQUARE.V_ORDER_HEADER_STG
),
rename as (
SELECT DISTINCT
       --MD5 KEYS
         OLIM.K_POS_CATALOG_OBJECT_DLHK AS K_POS_CATALOG_MODIFIER_DLHK
        ,OLI.K_POS_CATALOG_OBJECT_DLHK         
        --BUSINESS KEYS        
        ,OLIM.K_POS_CATALOG_OBJECT_BK AS K_POS_CATALOG_MODIFIER_BK     
        ,COALESCE(O.K_POS_LOCATION_BK,'N/A') AS K_POS_LOCATION_BK 
        ,CI.K_POS_CATALOG_OBJECT_BK
        --ATTRIBUTES
        ,COALESCE(CM.NAME, OLIM.A_POS_ORDER_LINE_MODIFIER_NAME) AS A_POS_PRODUCT_NAME
        ,NULL AS A_POS_PRODUCT_SUB_NAME        
        ,COALESCE(CI.A_POS_CATEGORY_NAME,'No Category') AS A_POS_CATEGORY_NAME 
        ,'ORDER LINE ITEM MODIFIER' AS A_POS_USAGE       
        --METRICS
        ,CM.PRICE_MONEY_AMOUNT AS M_PRICE_MONEY_AMOUNT        
        --DESCRIPTION
        ,CM.PRICE_MONEY_CURRENCY AS A_POS_PRICE_MONEY_CURRENCY
        ,CM.NAME AS A_POS_CATALOG_MODIFIER_NAME
        --metadata (MD)
        ,CURRENT_TIMESTAMP AS MD_LOAD_DTS        
        ,'58da106b-8574-48e3-a968-ba4a8e9431e6' AS MD_INTGR_ID
FROM
    source_order_line_item_modifier AS OLIM
    LEFT JOIN source_catalog_modifier AS CM ON CM.ID = OLIM.K_POS_CATALOG_OBJECT_BK    
    INNER JOIN source_order_line_item as OLI ON  OLIM.K_POS_ORDER_LINE_ITEM_BK = OLI.K_POS_ORDER_LINE_BK AND OLIM.K_POS_ORDER_BK = OLI.K_POS_ORDER_BK 
    LEFT JOIN source_order O ON O.K_POS_ORDER_DLHK = OLI.K_POS_ORDER_DLHK
    LEFT JOIN source_catalog_item CI ON CI.K_POS_CATALOG_OBJECT_VARIATION_BK = OLI.K_POS_CATALOG_OBJECT_BK    
)

SELECT * FROM rename