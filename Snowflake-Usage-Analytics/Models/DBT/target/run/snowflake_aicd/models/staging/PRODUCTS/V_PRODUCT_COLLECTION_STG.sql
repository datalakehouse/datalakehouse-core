
  create or replace  view DEVELOPER_SANDBOX.DBT_SHOPIFY.V_PRODUCT_COLLECTION_STG  as (
    
 

WITH source AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DEMO_SHOPIFY."COLLECT"
),
source_collection AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DEMO_SHOPIFY."COLLECTION"
),
product AS (
  SELECT * FROM  DEVELOPER_SANDBOX.DBT_SHOPIFY.W_PRODUCTS_D
),
rename as (

SELECT
  MD5(S.ID) AS K_PRODUCT_COLLECT_DLHK
  ,MD5(CC.ID) AS K_COLLECTION_DLHK
  ,P.K_PRODUCT_DLHK  
  ,S.ID AS K_PRODUCT_COLLECT_BK
  ,CC.ID AS K_COLLECTION_BK
  ,S.PRODUCT_ID AS K_PRODUCT_BK
  --ATTRIBUTES
  ,S.POSITION AS A_POSITION
  ,S.SORT_ORDER AS A_SORT_ORDER  
  ,S.CREATED_AT AS A_CREATED_AT_DTS
  ,S.UPDATED_AT AS A_UPDATED_AT_DTS
  ,CC.PUBLISHED_AT AS A_PUBLISHED_AT_DTS
  ,CC.BODY_HTML AS A_BODY_HTML
  ,CC.TITLE AS A_TITLE
  ,CC.HANDLE AS A_HANDLE
  ,CC.PUBLISHED_SCOPE AS A_PUBLISHED_SCOPE  
  ,CC.COLLECTION_TYPE AS A_COLLECTION_TYPE  
  --metrics
  ,CC.PRODUCTS_COUNT AS M_PRODUCTS_COUNT
  --metadata (MD)
  ,S.__DLH_IS_DELETED AS MD_IS_DELETED
  , CURRENT_TIMESTAMP AS MD_ELT_UPDATED_DTS        
  , 'cc5603df-43e1-42fa-bf2e-6c12e9f40242' AS MD_INTGR_ID
FROM
    source S
    LEFT JOIN source_collection CC ON CC.ID = S.COLLECTION_ID
    LEFT JOIN product P ON P.K_PRODUCT_BK = S.PRODUCT_ID
)

SELECT * FROM rename
  );
